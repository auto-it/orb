# To override the version of auto, set an AUTO_VERSION env var
version: 2.1

commands:
  get-version:
    description: Ensures the AUTO_VERSION env var is set for the current job
    steps:
      - run:
          command: |
            if [ -z "$AUTO_VERSION" ]; then
              AUTO_VERSION=$(curl -s https://api.github.com/repos/intuit/auto/releases/latest | jq -r .tag_name)
            fi
            echo "export AUTO_VERSION=$AUTO_VERSION" >> $BASH_ENV

  download-executable:
    parameters:
      platform:
        type: enum
        default: linux
        description: Which platform binary to download
        enum: ["linux", "macos", "win"]
    steps:
      - get-version
      - run:
          description: Download and unzipping auto binary
          command: |
            curl -L "https://github.com/intuit/auto/releases/download/$AUTO_VERSION/auto-<< parameters.platform >>.gz" -o auto.gz
            gzip -d auto.gz

  shipit:
    parameters:
      arguments:
        type: string
        description: Optional argument string to be passed to auto shipit
    steps:
      - download-executable
      - run: ./auto shipit << parameters.arguments >> $AUTO_SHIPIT_ARGS
